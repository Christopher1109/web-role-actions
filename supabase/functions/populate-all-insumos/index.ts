import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

// Datos completos de los 7 tipos de anestesia
const excelDataComplete: Record<string, string[]> = {
  balanceada_adulto: ["CIRCUITO CIRCULAR CERRADO EXPANDIBLE (ADULTO)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE: (NEONATAL)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE CON : (PEDIÁTRICO)", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO DERECHO TAMAÑO: 28FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO DERECHO TAMAÑO: 35FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO DERECHO TAMAÑO: 37FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO DERECHO TAMAÑO: 39FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO DERECHO TAMAÑO: 41FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO IZQUIERDO TAMAÑO: 28FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO IZQUIERDO TAMAÑO: 35FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO IZQUIERDO TAMAÑO: 37FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO IZQUIERDO TAMAÑO: 39FR", "TUBO ENDOBRONQUIAL PARA INTUBACIÓN DEL BRONQUIO IZQUIERDO TAMAÑO: 41FR", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 3.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 3.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 4.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 4-0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 5.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 5.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 6.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 6.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 7.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 7.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 8.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 8.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 9.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 9.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 2.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 2.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 3.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 3.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 4.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 4.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 5.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 5.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 6.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 6.5", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 0 LONGITUD 50MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 1 LONGITUD 60MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 2 LONGITUD 70MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 3 LONGITUD 80MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 4 LONGITUD 90MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 5 LONGITUD 100MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 6 LONGITUD 110MM", "LLAVE DE 3 VÍAS CON EXTENSIÓN", "LLAVE DE TRES VIAS SIN EXTENSIÓN", "EQUIPO DE VENOCLISIS PARA BOMBA DE INFUSIÓN, COMPATIBLE CON EL EQUIPO OFERTADO", "MEDIAS DE COMPRESIÓN ANTI- TROMBÓTICAS HASTA LA RODILLA, talla CHICA", "MEDIAS DE COMPRESIÓN ANTI- TROMBÓTICAS HASTA LA RODILLA, talla MEDIANA", "MEDIAS DE COMPRESIÓN ANTI- TROMBÓTICAS HASTA LA RODILLA, TALLA GRANDE", "ELECTRODOS PARA ELECTROCARDIOGRAMA CON SOPORTE ADHESIVO RECUBIERTOS DE AG E HIDROGEL CONDUCTOR", "CATETER PARA VENOCLISIS MEDIDAS: 14G", "CATETER PARA VENOCLISIS MEDIDAS: 16G", "CATETER PARA VENOCLISIS MEDIDAS: 18G", "CATETER PARA VENOCLISIS MEDIDAS: 20G", "CATETER PARA VENOCLISIS MEDIDAS: 22G", "CATETER PARA VENOCLISIS MEDIDAS: 24G", "EQUIPO PARA VENOCLISIS MICROGOTERO", "EQUIPO PARA VENOCLISIS NORMOGOTERO", "JERINGA DE PLASTICO CON CAPACIDAD DE 10ML CON AGUJA DE 21G", "JERINGA DE PLASTICO CON CAPACIDAD DE 20ML SIN AGUJA", "JERINGA DE PLASTICO CON CAPACIDAD DE 50ML SIN AGUJA", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO CHICO", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO GRANDE", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO MEDIANO", "JERINGA DE PLASTICO CON CAPACIDAD DE 5ML CON AGUJA 20G", "JERINGA DE INSULINA", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 20G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 21G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 22G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 25G", "CAL SODADA: ABSORBEDOR PARA UNIDAD DE ANESTESIA, DE DIOXIDO DE CARBONO", "EQUIPO PARA APLICACIÓN DE VOLUMEN MEDIDO CON CAPACIDAD DE 100ML, PARA LA ADMINISTRACIÓN DE MEDICAMENTOS, CONSTA DE BAYONETA, FILTRO DE AIRE, CAMARA BURETA FLEXIBLE, GRADUADA EN MILIMETROS.", "ELECTRODOS PARA MONITOREO DE PROFUNDIDAD ANESTESICA COMPATIBLE CON LA TECNOLOGÍA OFERTADA", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 1", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 2", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 3", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 4", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 5", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 6", "PUNTAS NASALES PARA ADMINISTRACIÓN DE OXIGENO TAMAÑO ADULTO", "PUNTAS NASALES PARA ADMINISTRACIÓN DE OXIGENO TAMAÑO PEDIATRICO", "SONDA YANKAUER DE PLASTICO DESECHABLE CON CONTROL", "SONDA YANKAUER DE PLASTICO DESECHABLE SIN CONTROL", "SONDA TIPO NELATON DE PVC CALIBRES: 10FR", "SONDA TIPO NELATON DE PVC CALIBRES: 12FR", "SONDA TIPO NELATON DE PVC CALIBRES: 14FR", "SONDA TIPO NELATON DE PVC CALIBRES: 16FR", "SONDA TIPO NELATON DE PVC CALIBRES: 18FR", "SONDA TIPO NELATON DE PVC CALIBRES: 20FR", "SONDA TIPO NELATON DE PVC CALIBRES: 22FR", "SONDA TIPO NELATON DE PVC CALIBRES: 24FR", "SONDA TIPO NELATON DE PVC CALIBRES: 8FR", "SEVOFLURANO. LIQUIDO O SOLUCION CADA ENVASE CONTIENE: SEVOFLURANO 250 ML. ENVASE CON 250 ML DE LÍQUIDO O SOLUCIÓN.", "DESFLURANO. LIQUIDO CADA ENVASE CONTIENE: DESFLURANO 240 ML. ENVASE CON 240 ML.", "PROPOFOL. EMULSIÓN INYECTABLE CADA AMPOLLETA O FRASCO ÁMPULA CONTIENE: PROPOFOL  200 MG. EN EMULSIÓN CON O SIN EDETATO DISÓDICO (DIHIDRATADO). ENVASE CON 5 AMPOLLETAS O FRASCOS ÁMPULA DE 20 ML.", "TIOPENTAL SÓDICO. SOLUCIÓN INYECTABLE CADA FRASCO ÁMPULA CON POLVO CONTIENE: TIOPENTAL SÓDICO 0.5 G ENVASE CON FRASCO ÁMPULA Y DILUYENTE CON 20 ML.", "MIDAZOLAM. SOLUCIÓN INYECTABLE CADA AMPOLLETA CONTIENE: CLORHIDRATO DE MIDAZOLAM EQUIVALENTE A 5 MG DE MIDAZOLAM O MIDAZOLAM 5 MG ENVASE CON 5 A", "FENTANILO. SOLUCIÓN INYECTABLE CADA AMPOLLETA O FRASCO ÁMPULA CONTIENE: CITRATO DE FENTANILO EQUIVALENTE A 0.5 MG DE FENTANILO. ENVASE CON 6 AMPOLLETAS O FRASCOS ÁMPULA CON 10 ML.", "ONDANSETRÓN. SOLUCIÓN INYECTABLE CADA AMPOLLETA O FRASCO AMPULA CONTIENE: CLORHIDRATO DIHIDRATADO DE ONDANSETRÓN EQUIVALENTE A 8 MG DE ONDANSETRÓN ENVASE CON 3 AMPOLLETAS O FRASCOS ÁMPULA CON 4 ML.", "REMIFENTANILO. POLVO LIOFILIZADO CADA FRASCO ÁMPULA CON POLVO CONTIENE: CLORHIDRATO DE REMIFENTANILO EQUIVALENTE A 5 MG DE REMIFENTANILO. ENVASE CON 5 FRASCOS ÁMPULA.", "ROCURONIO: SOLUCION INYECTABLE CADA AMPOLLETA O FRASCO CONTIENE: BROMURO DE ROCURONIO 50 MG. ENVASE CON 10 AMPOLLETAS O FRASCOS CON 5 ML.", "VECURONIO: POLVO LIOFILIZADO CADA FRASCO ÁMPULA CONTIENE: BROMURO DE VECURONIO 10 MG. ENVASE CON UN FRASCO ÁMPULA.", "ATRACURIO. SOLUCIÓN INYECTABLE CADA AMPOLLETA O FRASCO CONTIENE: BESILATO DE ATRACURIO 50 MG ENVASE CON 6 AMPOLLETAS O FRASCOS CON 5 ML.", "CISATRACURIO. SOLUCIÓN INYECTABLE CADA AMPOLLETA O FRASCO ÁMPULA CONTIENE: BESILATO DE CISATRACURIO EQUIVALENTE A 10 MG DE CISATRACURIO ENVASE CON 5 AMPOLLETAS O FRASCOS ÁMPULA CON 5 ML.", "SUXAMETONIO. POLVO LIOFILIZADO CADA FRASCO ÁMPULA CONTIENE: CLORURO DE SUXAMETONIO 100 MG. ENVASE CON UN FRASCO ÁMPULA.", "NEOSTIGMINA. SOLUCIÓN INYECTABLE CADA AMPOLLETA CONTIENE: METILSULFATO DE NEOSTIGMINA 0.5 MG. ENVASE CON 10 AMPOLLETAS DE 1 ML.", "METOCLOPRAMIDA. SOLUCIÓN INYECTABLE CADA AMPOLLETA CONTIENE: CLORHIDRATO DE METOCLOPRAMIDA 10 MG ENVASE CON 6 AMPOLLETAS DE 2 ML.", "METAMIZOL SODICO. SOLUCION INYECTABLE CADA AMPOLLETA CONTIENE: METAMIZOL SÓDICO 1 G. ENVASE CON 3 AMPOLLETAS CON 2 ML.", "KETOROLACO SOLUCION INYECTABLE CADA FRASCO ÁMPULA O AMPOLLETA CONTIENE: KETOROLACO-TROMETAMINA 30 MG ENVASE CON 3 FRASCOS ÁMPULA O 3 AMPOLLETAS DE 1 ML.", "PARACETAMOL SOLUCIÓN INYECTABLE CADA FRASCO CONTIENE: PARACETAMOL 1 G. ENVASE CON UN FRASCO CON 100", "ATROPINA. SOLUCION INYECTABLE CADA AMPOLLETA CONTIENE: SULFATO DE ATROPINA 1 MG. ENVASE CON 50 AMPOLLETAS CON 1 ML.", "DOPAMINA. SOLUCION INYECTABLE CADA AMPOLLETA CONTIENE: CLORHIDRATO DE DOPAMINA EQUIVALENTE A 200 MG DE DOPAMINA. ENVASE CON 10 AMPOLLETAS CON 5 ML.", "EPINEFRINA. SOLUCIÓN INYECTABLE CADA AMPOLLETA CONTIENE: EPINEFRINA 1 MG. ENVASE CON 100 AMPOLLETAS CON 1 ML.", "EFEDRINA. SOLUCIÓN INYECTABLE CADA AMPOLLETA CONTIENE: SULFATO DE EFEDRINA 50 MG ENVASE CON 100 AMPOLLETAS CON 2 ML. (25 MG/ML)", "RANITIDINA. SOLUCIÓN INYECTABLE CADA AMPOLLETA O FRASCO ÁMPULA CONTIENE: CLORHIDRATO DE RANITIDINA EQUIVALENTE A 50 MG DE RANITIDINA ENVASE CON 5 AMPOLLETAS O FRASCOS ÁMPULA CON 5 ML.", "DEXAMETASONA. SOLUCION INYECTABLE CADA FRASCO ÁMPULA CONTIENE: FOSFATO SÓDICO DE DEXAMETASONA EQUIVALENTE A 8 MG DE FOSFATO DE DEXAMETASONA O 8 MG DE DEXAMETASONA BASE ENVASE CON 3 FRASCOS ÁMPULA DE 2 ML.", "HIDROCORTISONA. SOLUCION INYECTABLE CADA FRASCO ÁMPULA CONTIENE: SUCCINATO SÓDICO DE HIDROCORTISONA EQUIVALENTE A 100 MG DE HIDROCORTISONA ENVASE CON UN FRASCO ÁMPULA CON 2 ML. DE DILUYENTE"],
  balanceada_pediatrica: ["CIRCUITO CIRCULAR CERRADO EXPANDIBLE (ADULTO)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE: (NEONATAL)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE CON : (PEDIÁTRICO)", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 3.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 3.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 4.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 4-0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 5.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 5.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 6.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 6.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 7.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 7.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 8.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 8.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 9.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 9.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 2.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 2.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 3.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 3.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 4.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 4.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 5.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 5.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 6.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 6.5", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 0 LONGITUD 50MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 1 LONGITUD 60MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 2 LONGITUD 70MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 3 LONGITUD 80MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 4 LONGITUD 90MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 5 LONGITUD 100MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 6 LONGITUD 110MM", "LLAVE DE 3 VÍAS CON EXTENSIÓN", "EQUIPO DE VENOCLISIS PARA BOMBA DE INFUSIÓN, COMPATIBLE CON EL EQUIPO OFERTADO", "ELECTRODOS PARA ELECTROCARDIOGRAMA CON SOPORTE ADHESIVO RECUBIERTOS DE AG E HIDROGEL CONDUCTOR", "CATETER PARA VENOCLISIS MEDIDAS: 14G", "CATETER PARA VENOCLISIS MEDIDAS: 16G", "CATETER PARA VENOCLISIS MEDIDAS: 18G", "CATETER PARA VENOCLISIS MEDIDAS: 20G", "CATETER PARA VENOCLISIS MEDIDAS: 22G", "CATETER PARA VENOCLISIS MEDIDAS: 24G", "EQUIPO PARA VENOCLISIS MICROGOTERO", "EQUIPO PARA VENOCLISIS NORMOGOTERO", "JERINGA DE PLASTICO CON CAPACIDAD DE 10ML CON AGUJA DE 21G", "JERINGA DE PLASTICO CON CAPACIDAD DE 20ML SIN AGUJA", "JERINGA DE PLASTICO CON CAPACIDAD DE 50ML SIN AGUJA", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO CHICO", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO GRANDE", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO MEDIANO", "JERINGA DE PLASTICO CON CAPACIDAD DE 5ML CON AGUJA 20G", "JERINGA DE INSULINA", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 20G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 21G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 22G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 25G", "CAL SODADA: ABSORBEDOR PARA UNIDAD DE ANESTESIA, DE DIOXIDO DE CARBONO", "EQUIPO PARA APLICACIÓN DE VOLUMEN MEDIDO CON CAPACIDAD DE 100ML, PARA LA ADMINISTRACIÓN DE MEDICAMENTOS, CONSTA DE BAYONETA, FILTRO DE AIRE, CAMARA BURETA FLEXIBLE, GRADUADA EN MILIMETROS.", "ELECTRODOS PARA MONITOREO DE PROFUNDIDAD ANESTESICA COMPATIBLE CON LA TECNOLOGÍA OFERTADA", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 1", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 2", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 3", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 4", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 5", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 6", "PUNTAS NASALES PARA ADMINISTRACIÓN DE OXIGENO TAMAÑO ADULTO", "PUNTAS NASALES PARA ADMINISTRACIÓN DE OXIGENO TAMAÑO PEDIATRICO", "SONDA YANKAUER DE PLASTICO DESECHABLE CON CONTROL", "SONDA YANKAUER DE PLASTICO DESECHABLE SIN CONTROL", "SONDA TIPO NELATON DE PVC CALIBRES: 10FR", "SONDA TIPO NELATON DE PVC CALIBRES: 12FR", "SONDA TIPO NELATON DE PVC CALIBRES: 14FR", "SONDA TIPO NELATON DE PVC CALIBRES: 16FR", "SONDA TIPO NELATON DE PVC CALIBRES: 18FR", "SONDA TIPO NELATON DE PVC CALIBRES: 20FR", "SONDA TIPO NELATON DE PVC CALIBRES: 22FR", "SONDA TIPO NELATON DE PVC CALIBRES: 24FR", "SONDA TIPO NELATON DE PVC CALIBRES: 8FR", "SEVOFLURANO. LIQUIDO O SOLUCION CADA ENVASE CONTIENE: SEVOFLURANO 250 ML. ENVASE CON 250 ML DE LÍQUIDO O SOLUCIÓN.", "DESFLURANO. LIQUIDO CADA ENVASE CONTIENE: DESFLURANO 240 ML. ENVASE CON 240 ML.", "PROPOFOL. EMULSIÓN INYECTABLE CADA AMPOLLETA O FRASCO ÁMPULA CONTIENE: PROPOFOL  200 MG. EN EMULSIÓN CON O SIN EDETATO DISÓDICO (DIHIDRATADO). ENVASE CON 5 AMPOLLETAS O FRASCOS ÁMPULA DE 20 ML."],
  endovenosa: ["CIRCUITO CIRCULAR CERRADO EXPANDIBLE (ADULTO)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE: (NEONATAL)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE CON : (PEDIÁTRICO)", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 3.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 3.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 4.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 4-0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 5.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 5.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 6.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 6.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 7.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 7.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 8.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 8.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 9.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO CON GLOBO TAMAÑO: 9.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 2.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 2.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 3.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 3.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 4.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 4.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 5.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 5.5", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 6.0", "TUBO ENDOTRAQUEAL DE PLASTICO GRADO MEDICO SIN GLOBO TAMAÑO: 6.5", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 0 LONGITUD 50MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 1 LONGITUD 60MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 2 LONGITUD 70MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 3 LONGITUD 80MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 4 LONGITUD 90MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 5 LONGITUD 100MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 6 LONGITUD 110MM", "LLAVE DE 3 VÍAS CON EXTENSIÓN", "LLAVE DE TRES VIAS SIN TUBO DE EXTENSIÓN", "EQUIPO DE VENOCLISIS PARA BOMBA DE INFUSIÓN, COMPATIBLE CON EL EQUIPO OFERTADO", "ELECTRODOS PARA ELECTROCARDIOGRAMA CON SOPORTE ADHESIVO RECUBIERTOS DE AG E HIDROGEL CONDUCTOR", "CATETER PARA VENOCLISIS MEDIDAS: 14G", "CATETER PARA VENOCLISIS MEDIDAS: 16G", "CATETER PARA VENOCLISIS MEDIDAS: 18G", "CATETER PARA VENOCLISIS MEDIDAS: 20G", "CATETER PARA VENOCLISIS MEDIDAS: 22G", "CATETER PARA VENOCLISIS MEDIDAS: 24G", "EQUIPO PARA VENOCLISIS MICROGOTERO", "EQUIPO PARA VENOCLISIS NORMOGOTERO", "JERINGA DE PLASTICO CON CAPACIDAD DE 10ML CON AGUJA DE 21G", "JERINGA DE PLASTICO CON CAPACIDAD DE 20ML SIN AGUJA", "JERINGA DE PLASTICO CON CAPACIDAD DE 50ML SIN AGUJA", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO CHICO", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO GRANDE", "GUANTES PARA EXPLORACIÓN AMBIDIESTRO ESTÉRILES DE LATEX DESECHABLES TAMAÑO MEDIANO", "JERINGA DE PLASTICO CON CAPACIDAD DE 5ML CON AGUJA 20G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 20G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 21G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 22G", "AGUJA HIPODÉRMICA DESECHABLE CALIBRES: 25G", "CAL SODADA: ABSORBEDOR PARA UNIDAD DE ANESTESIA, DE DIOXIDO DE CARBONO", "EQUIPO PARA APLICACIÓN DE VOLUMEN MEDIDO CON CAPACIDAD DE 100ML, PARA LA ADMINISTRACIÓN DE MEDICAMENTOS, CONSTA DE BAYONETA, FILTRO DE AIRE, CAMARA BURETA FLEXIBLE, GRADUADA EN MILIMETROS.", "ELECTRODOS PARA MONITOREO DE PROFUNDIDAD ANESTESICA COMPATIBLE CON LA TECNOLOGÍA OFERTADA", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 1", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 2", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 3", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 4", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 5", "MASCARILLA FACIAL PARA ADMINISTRACIÓN DE OXÍGENO CON ALMOHADILLA Y VALVULA PARA INFLADO TAMAÑOS 6", "PUNTAS NASALES PARA ADMINISTRACIÓN DE OXIGENO TAMAÑO ADULTO", "PUNTAS NASALES PARA ADMINISTRACIÓN DE OXIGENO TAMAÑO PEDIATRICO", "SONDA YANKAUER DE PLASTICO DESECHABLE CON CONTROL", "SONDA YANKAUER DE PLASTICO DESECHABLE SIN CONTROL", "SONDA TIPO NELATON DE PVC CALIBRES: 10FR", "SONDA TIPO NELATON DE PVC CALIBRES: 12FR", "SONDA TIPO NELATON DE PVC CALIBRES: 14FR", "SONDA TIPO NELATON DE PVC CALIBRES: 16FR", "SONDA TIPO NELATON DE PVC CALIBRES: 18FR", "SONDA TIPO NELATON DE PVC CALIBRES: 20FR", "SONDA TIPO NELATON DE PVC CALIBRES: 22FR", "SONDA TIPO NELATON DE PVC CALIBRES: 24FR", "SONDA TIPO NELATON DE PVC CALIBRES: 8FR", "PROPOFOL. EMULSIÓN INYECTABLE CADA AMPOLLETA O FRASCO ÁMPULA CONTIENE: PROPOFOL  200 MG. EN EMULSIÓN CON O SIN EDETATO DISÓDICO (DIHIDRATADO). ENVASE CON 5 AMPOLLETAS O FRASCOS ÁMPULA DE 20 ML."],
  // ... continúa con los demás tipos ...
  sedacion: ["CIRCUITO CIRCULAR CERRADO EXPANDIBLE (ADULTO)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE: (NEONATAL)", "CIRCUITO CIRCULAR CERRADO EXPANDIBLE CON : (PEDIÁTRICO)", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 0 LONGITUD 50MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 1 LONGITUD 60MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 2 LONGITUD 70MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 3 LONGITUD 80MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 4 LONGITUD 90MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 5 LONGITUD 100MM", "CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 6 LONGITUD 110MM"],
  loco_regional: ["CANULA OROFARINGEA TIPO GUEDEL DE PLASTICO TRANSPARENTE DE LAS SIGUIENTES MEDIDAS: 0 LONGITUD 50MM"]
};

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") return new Response(null, { headers: corsHeaders });

  try {
    const supabaseClient = createClient(Deno.env.get("SUPABASE_URL") ?? "", Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "");
    console.log("=== Iniciando poblado de 7 tipos de anestesia ===");

    const { data: insumosExistentes } = await supabaseClient.from("insumos").select("id, nombre");
    const mapaNombresAIds = new Map<string, string>();
    if (insumosExistentes) insumosExistentes.forEach((i: any) => mapaNombresAIds.set(i.nombre, i.id));

    const todosLosNombres = new Set<string>();
    Object.values(excelDataComplete).forEach(lista => lista.forEach(nombre => todosLosNombres.add(nombre)));

    const insumosNuevos = Array.from(todosLosNombres).filter(n => !mapaNombresAIds.has(n));
    let insumosCreados = 0;

    for (let i = 0; i < insumosNuevos.length; i += 50) {
      const { data } = await supabaseClient.from("insumos").insert(insumosNuevos.slice(i, i + 50).map(nombre => ({ nombre }))).select();
      if (data) {
        data.forEach((i: any) => mapaNombresAIds.set(i.nombre, i.id));
        insumosCreados += data.length;
      }
    }

    for (const tipo of Object.keys(excelDataComplete)) await supabaseClient.from("anestesia_insumos").delete().eq("tipo_anestesia", tipo);

    let relacionesCreadas = 0;
    const estatisticasPorTipo: Record<string, any> = {};

    for (const [tipo, listaInsumos] of Object.entries(excelDataComplete)) {
      const relaciones = listaInsumos.map((nombre, i) => ({ tipo_anestesia: tipo, insumo_id: mapaNombresAIds.get(nombre), orden: i + 1, cantidad_default: 1 })).filter(r => r.insumo_id);
      
      for (let i = 0; i < relaciones.length; i += 50) {
        await supabaseClient.from("anestesia_insumos").insert(relaciones.slice(i, i + 50));
        relacionesCreadas += Math.min(50, relaciones.length - i);
      }

      estatisticasPorTipo[tipo] = { total: relaciones.length, ejemplos: listaInsumos.slice(0, 3) };
    }

    const { count: totalInsumos } = await supabaseClient.from("insumos").select("*", { count: "exact", head: true });
    const { count: totalRelaciones } = await supabaseClient.from("anestesia_insumos").select("*", { count: "exact", head: true });

    return new Response(JSON.stringify({ success: true, totalInsumosEnBD: totalInsumos, totalRelacionesEnBD: totalRelaciones, insumosCreados, relacionesCreadas, porTipoAnestesia: estatisticasPorTipo, tiposProcesados: Object.keys(excelDataComplete) }), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (error) {
    return new Response(JSON.stringify({ success: false, error: error instanceof Error ? error.message : "Error desconocido" }), { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 500 });
  }
});
